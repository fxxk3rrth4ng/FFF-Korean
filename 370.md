# Friday Facts #370

## 2022-09-23, [Twinsen](https://factorio.com/blog/author/Twinsen), [kovarex](https://factorio.com/blog/author/kovarex)

---

[원문 확인하기](https://factorio.com/blog/post/fff-370)

저희는 팩토리오를 콘솔과 모바일을 포함한 다른 플랫폼으로 옮기려는 시도를 오랫동안 해왔습니다. ([만우절](./132.md)은 제외하고요.) 저희는 심지어 몇몇 외부 회사와도 작업을 했지만, 프로젝트는 컨트롤러나 터치스크린으로 플레이할 수 있는 것은 말할 것도 없고 기술적으로 실행하는데에도 도달하지 못했습니다. 그런 시도 끝에, 저희는 심지어 "다른 플랫폼으로의 이식 계획은 없다"는 내용의 Friday Facts까지 준비를 했었습니다.

---

### Nintendo Switch로의 여정 (kovarex)

저는 Nintendo Switch 시스템, 특히 탈착하여 각각 한 손에 쥘 수 있는 Joy-Con 컨트롤러의 굉장한 팬입니다. 팩토리오를 Nintendo Switch로 옮기는 것은 제가 오랫동안 마음에 담아두고 있었던 것이었죠. 2021년 2월 즈음에 저희가 팀의 미래와 다음에 작업할 것을 논의하고 있을 때, 저는 Nintendo Switch로 옮기는 것을 결정했습니다. 그리고 기초 조사 끝에, 그것은 그렇게 오래 걸릴 것 같지 않아보였습니다. 

이야기를 진행하기 이전에, 저는 프로젝트가 알 수 없는 것들로 가득했다는 점을 설명하고 싶고, 그것들은 다음과 같습니다. 

* 그래픽 백엔드를 갈아엎지 않고도 기술적 포팅이 가능한가?
* Nintendo Switch의 시스템이 적정한 성능을 유지하며 게임을 구동할 수 있는가?
* 게임을 컨트롤러로 플레이할 수 있는가?
* 프로젝트가 너무 크진 않은가?

저희는 팩토리오 관련된 부프로젝트들을 시작했다 수년간의 개발 지옥에 빠져 끝난 적이 있기 때문에, 저의 이 프로젝트에서의 목표는 부분들이 그저 빠르고 더러운 프로토타입이 아니라는 것을 보이는 것에 최선을 다하면서 항상 빠르게 실패하는 것이었습니다. 만약 위와 같은 질문에 대한 답이 명확하게 아니라면 프로젝트는 취소될 것이었고, 아슬아슬 했던 적도 있었습니다 :)

### 컴파일 그리고 첫 가동

그래서 우리는 개발자 액세스를 신청했고 빨리 얻었습니다. 그리고 첫 번째 문제는 앞에 있었습니다. 과연 팩토리오를 Nintendo Switch용으로 컴파일할 수 있을까? 특히 저희는 맞춤형 [FASTBuild](https://www.fastbuild.org/docs/home.html) 스크립트를 사용하여 팩토리오와 모든 라이브러리를 빌드하기 때문입니다. 운 좋게도 Nintendo Switch 문서는 매우 상세합니다. 빌드 시스템의 많은 세부 사항을 이해한 후에, 저는 Nintendo Switch용 팩토리오를 빌드하는 FASTBuild 스크립트를 만들 수 있었습니다.

**2021년 3월 3일** - 저에게는 첫 번째 중요한 단계가 있었는데, 모든 컴파일 오류가 수정되었으며 실행 파일이 올바르게 링크되었습니다.
**2021년 3월 4일** - 전체 게임 패키지를 빌드하고 devkit에서 실행할 수 있었습니다. 시작은 성공했지만 즉시 충돌했습니다.
그 뒤를 이어 창 초기화, 오디오, 파일 시스템 초기화 및 액세스, 네트워크 스택 초기화 처리와 같은 많은 수정 및 기술 문제가 있었습니다. 그리고 문제가 언제 끝날지 알 수 없는 큰 프로젝트에서는 가장 명백한 문제를 수정하고 다음으로 이동한 다음 게임을 다시 실행하고 다음 충돌이나 오류가 어디에서 발생할지 실제로 알지 못한 채 반복했습니다.

**2021년 3월 29일** - 매우 중요한 단계를 거쳤고 로그에는 "1212.940 팩토리오 초기화됨"이라는 글이 나왔습니다. 팩토리오는 성공적으로 메인 화면으로 들어가졌습니다.

<div class="video-container" style="text-align:center;position:relative;padding-bottom:56.25%;padding-top:0px;height:0;overflow:hidden;">
	<iframe style="position:absolute;top:0;left:0;width:100%; height:100%;" src="https://cdn.factorio.com/assets/img/blog/fff-370-first-run.mp4" frameborder="0" crolling="no" frameborder="none" allowfullscreen="" ></iframe>
</div>


그것은, 특히 모든게 갑자기 진행되는 것처럼 보일 때는, 엄청난 기분이었습니다. 백그라운드 시뮬레이션이 정확이 렌더되었고, 소리와 음악이 흘러나오고, 심지어 터치스크린을 이용한 GUI와의 상호작용도 진행되었습니다. 이제 모든 수정 및 구현이 마침내 표시되었습니다.

### 성능

그러나 예리한 눈을 가진 사람들은 "1212.940 Factorio initialised"의 문제를 알아차릴 수 있었을 것입니다. 1212.940은 초 단위의 타임스탬프입니다. 게임을 로드하고 메인 메뉴에 도달하는 데 20분이 걸린 것입니다...

그것은 디버그 빌드였기 때문에, 숫자는 그렇게 큰 것이 아니었지만, 시작 시간은 저희가 릴리즈 직전까지 다투는 것입니다. 이제 게임이 내부 저장소에 설치되는 최종 시작 시간은 70초이지만 너무 앞서가지는 맙시다.

The next step was doing all the obvious performance optimizations and deciding if the performance is good enough. There were many optimizations to do but the task was made easier thanks to the development tools. It allowed me to make many Nintendo Switch specific optimizations, and even some [optimizations for the PC version](https://forums.factorio.com/viewtopic.php?f=3&t=101968). Answering "is the performance good enough" is not an easy question, because, what is "good enough"? I settled for "the average player should be able to finish the game by launching a rocket and the game should maintain 60 UPS". Luckily, the performance met that target, even if it was quite close.

### 멀티플레이

그런 식으로, 다음 단계는 멀티플레이어 결정론이었습니다. 한 가지 큰 목표는 게임에서 멀티플레이어를 빼고 싶지 않다는 것이었습니다. 또한 PC 플레이어가 Nintendo Switch 플레이어와 함께 플레이하기를 원했습니다. 게임이 ARM과 x86 사이에서 결정론적인지 확인해야 했던 것은 이번이 처음이었습니다. 아마 괜찮을거에요. C++는 포터블이니까요. 맞죠? [정의되지 않은 행동](https://en.wikipedia.org/wiki/Undefined_behavior)만 사용하지 않으면 돼요. 우리는 메인 코드와 라이브러리 모두에서 정의되지 않은 행동을 꽤 많이 사용하는 것으로 나타났습니다. 예를 들어 실수를 정수로 캐스팅할 때 값이 정수에 맞지 않으면 정의되지 않은 동작으로 간주되며 그 결과값은 ARM 및 x86 CPU에서 다릅니다.

정의되지 않은 행동의 모든 사용을 제거하는 것은 아마도 어리석은 짓일 것입니다. 코드 전체에 상당한 변경이 필요하고 시간이 걸리고 성능에 영향을 미치며 즉각적인 실질적인 이점은 없기 때문입니다. 그래서 저는 실제로 결정론을 깨뜨린 정의되지 않은 행동의 사례를 찾았습니다. 결정론을 테스트하는 데 사용하는 도구가 많기 때문에 이것은 충분히 쉬웠습니다. x86과 ARM 사이의 모든 테스트(2,417번의 테스트를 진행함)의 모든 틱에 대한 게임 상태 CRC를 비교함으로써 잠재적인 문제에 대해 꽤 잘 다루고 있다고 생각합니다. 발견된 모든 문제를 수정한 후에도 여전히 일부 멀티플레이어 비동기화가 있을 수 있지만 플레이어는 남아 있는 비동기화를 찾는 데 도움을 주어야 합니다.

### 컨트롤러

The next big step was making the game playable with controllers. Factorio was developed for 10 years with only keyboard and mouse in mind. We also have 146 controls (mappable actions), while a controller typically has 16 buttons and 2 joysticks. I'm trying to create a control scheme that:

* Has all the important actions.
* Is intuitive for new players and existing players.
* Respects known standards.
* Makes sure the most common tasks are fast.

I needed to accomplish these while not redesigning the GUI from scratch, and not rewriting huge parts of the game. All this is enough to give you brain damage. Nonetheless, I had an idea of how to do it, since I spent some time planning this before starting the project, to make sure it's even reasonably possible.

### GUI

One of the challenges was how to navigate the GUI. Something that was clearly out of the question was dumbing down the GUI on all platforms for the sake of controllers, like many games do. There are many PC games out there with terrible "console port" GUIs; Factorio's will always be designed with keyboard and mouse in mind first. Another thing that was also out of the question was redoing the GUI for controllers. We have hundreds of GUIs that took years to design and implement, and some are still being changed. Redesigning and changing most of them again would also take years.

So the only remaining solution was to use mostly the same layouts and navigate through widgets using a controller stick. It seems simple, but under the hood there's a pretty complex heuristic algorithm. For example when pressing left on the stick, the algorithm will look through all the interactive widgets on the left, and pick the best one based on factors such current widget and candidate widget bounding boxes, positions, what parent type is it a part of, what is the bounding box of that parent, etc.

Here's a short video of what interacting with the GUI looks like:

<div class="video-container" style="text-align:center;position:relative;padding-bottom:56.25%;padding-top:0px;height:0;overflow:hidden;">
	<iframe style="position:absolute;top:0;left:0;width:100%; height:100%;" src="https://cdn.factorio.com/assets/img/blog/fff-370-gui-navigation.mp4" frameborder="0" crolling="no" frameborder="none" allowfullscreen="" ></iframe>
</div>

Another important part was updating the quickbar. I added a new UI called the "Quick panel". It's a radial menu that is open while holding L (left bumper) and allows quick access to items, tools and panels.

<div class="video-container" style="text-align:center;position:relative;padding-bottom:56.25%;padding-top:0px;height:0;overflow:hidden;">
	<iframe style="position:absolute;top:0;left:0;width:100%; height:100%;" src="https://cdn.factorio.com/assets/img/blog/fff-370-quick-panel.mp4" frameborder="0" crolling="no" frameborder="none" allowfullscreen="" ></iframe>
</div>


### 마무리

Near the end of August 2021 the main game was fully playable on Nintendo Switch. I work remotely, and at that time we had a meet-up so I took the opportunity to force ask the other team members to play through the game while I watch them, to see how intuitive it is for those who play with a controller for the first time. The feedback was mostly positive and I also had an idea of what parts should be improved.

And with that, the last major part of the port was done. Just polish it and ship it, the game should be ready to launch by the end of the year (2021)... But we are releasing on 28th October 2022, so what happened in the meantime? As expected, things take longer that expected. The [ninety-ninety rule](https://en.wikipedia.org/wiki/Ninety%E2%80%93ninety_rule) (or similar) roughly holds true. Also, remember that I wanted to "fail fast", so I wanted a playable [vertical slice](https://en.wikipedia.org/wiki/Vertical_slice) as soon as possible. Now it was time to go back and make sure everything was done properly. Plus, there were still many, many small things to do:

* More playtesting and polishing playing with a controller.
* Tweaking the heuristic algorithm that navigates the GUI so it's intuitive and works for all our hundreds of GUIs.
* Making sure all our custom GUI widgets can be interacted with a controller, this includes switches, sliders, train minimap, equipment grid, etc.
* More optimizations to UPS, FPS and loading times.
* Experimenting with adding vibrations. The Joy-Con controllers and Nintendo Switch Pro Controller support HD Rumble. After some testing and experimentation I decided it's worth it to use this functionality and add many custom vibrations to enhance the experience.
* Updating the tutorial campaign, Mini-tutorials, Tips and tricks.
* [Localisation.](https://crowdin.com/project/factorio/discussions/214)
* Age ratings.
* In-game and server back-end changes to support quick authentication of Nintendo Switch players.
* [Bugs](https://cdn.factorio.com/assets/img/blog/fff-370-bug.mp4)
* Implementing and making sure Nintendo's requirements were met. Releasing a game on a game console means it needs to comply with many requirements and go through a review process.

Even after the launch, there is much to do. Next to my screen there's a stack of post-it notes with future improvements, possible features and technical debt I need to solve. As mentioned in the announcement last week, after the launch I will also work on controller support for PC and Steam Deck.

It was mostly my pet project and I was the only one working full time on it. I tried to let the rest of the team focus on the expansion and not get in the way, but others helped me out with some things, such as graphics optimizations, audio optimizations, web backend, testing, playtesting, feedback and other small tasks. So as with everything, it's a team effort. Also many contacts at Nintendo offered support with the launch and development. It was an honour to be featured in an event as big as Nintendo Direct.

---

### 좋은데, 확장은요? (kovarex)

It wouldn't be fair to not address the elephant in the room, which is the progress on the expansion. We have been working hard on it and have a lot of progress, but still haven't shared any specifics for the strategic reasons mentioned previously.

In the [FFF-367](./367.md) we specified that we are in Step 4, and now we can say, that we are somewhere deep in Step 5. First, I had a playthrough from start to finish, where we had to assemble and fix systems on the go. It was very rough and long, partially because I had to repeatedly update the factory as we implemented changes.

But the result was the game being playable from start to finish. Having a "skeleton" of the playthrough was critical for managing the team, as people could more efficiently split their effort into more independent sections of the game.

The second playthrough was a week-long office LAN-party in July 2022, where 12 people spent 5 full days racing to finish the game before the end of the week. Some of us took family vacations because of this, so we tried to get the most out of it. You can imagine how intense it was, and how destroyed we were at the end. But it was a great experience, and playing one playthough in one continuous session, gave us an accurate feeling of the overall pacing. The key takeaway was that the game was too long, and some parts were too boring or repetitive.

Since then, we mainly focused on fixing the problems identified. Also, a lot of the things we used in the playthrough technically work, but its look and feel is very simplified as it is a prototype. Imagine an inserter prototype which moves things from A to B, but it is a grey square and doesn't swing its arm. This is the state of a lot things at the moment.

The reason why we still don't share specific details is, that we have to sadly inform you, that it still won't be ready sooner than in a year from now. Once the estimates get reasonably close, we will start dropping some FFFs.

---

As always, you can let us know what you think at the usual places.
